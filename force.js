var dataset = [{
    "Year": 1987,
    "Title": "Whispering Jack",
    "Artist": "John Farnham",
    "Genre": "Pop",
    "Female-fronted": "Not female-fronted",
    "Released": "Released independently and distributed by a major label",
    "Origin": "Victoria"
}, {
    "Year": 1988,
    "Title": "Man Of Colours",
    "Artist": "Icehouse",
    "Genre": "Rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released and distributed independently",
    "Origin": "New South Wales"
}, {
    "Year": 1989,
    "Title": "Temple Of Low Men",
    "Artist": "Crowded House",
    "Genre": "Rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released and distributed on a major label",
    "Origin": "Victoria"
}, {
    "Year": 1990,
    "Title": "Matchbook",
    "Artist": "Ian Moss",
    "Genre": "Rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released and distributed independently",
    "Origin": "Northern Territory"
}, {
    "Year": 1991,
    "Title": "Blue Sky Mining",
    "Artist": "Midnight Oil",
    "Genre": "Rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released independently and distributed by a major label",
    "Origin": "New South Wales"
}, {
    "Year": 1992,
    "Title": "Baby Animals",
    "Artist": "Baby Animals",
    "Genre": "Rock",
    "Female-fronted": "Female-fronted",
    "Released": "Released independently and distributed by a major label",
    "Origin": "New South Wales"
}, {
    "Year": 1993,
    "Title": "Hepfidelity",
    "Artist": "Diesel",
    "Genre": "Rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released and distributed on a major label",
    "Origin": "Western Australia"
}, {
    "Year": 1994,
    "Title": "The Honeymoon Is Over",
    "Artist": "The Cruel Sea",
    "Genre": "Rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released independently and distributed by a major label",
    "Origin": "New South Wales"
}, {
    "Year": 1995,
    "Title": "Don't Ask",
    "Artist": "Tina Arena",
    "Genre": "Pop",
    "Female-fronted": "Female-fronted",
    "Released": "Released and distributed on a major label",
    "Origin": "Victoria"
}, {
    "Year": 1996,
    "Title": "Hourly, Daily",
    "Artist": "You Am I",
    "Genre": "Alternative rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released independently and distributed by a major label",
    "Origin": "New South Wales"
}, {
    "Year": 1997,
    "Title": "Savage Garden",
    "Artist": "Savage Garden",
    "Genre": "Pop",
    "Female-fronted": "Not female-fronted",
    "Released": "Released and distributed on a major label",
    "Origin": "Queensland"
}, {
    "Year": 1998,
    "Title": "Unit",
    "Artist": "Regurgitator",
    "Genre": "Alternative rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released and distributed on a major label",
    "Origin": "Queensland"
}, {
    "Year": 1999,
    "Title": "Internationalist",
    "Artist": "Powderfinger",
    "Genre": "Alternative rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released and distributed on a major label",
    "Origin": "Queensland"
}, {
    "Year": 2000,
    "Title": "Reflector",
    "Artist": "Killing Heidi",
    "Genre": "Rock",
    "Female-fronted": "Female-fronted",
    "Released": "Released independently and distributed by a major label",
    "Origin": "Victoria"
}, {
    "Year": 2001,
    "Title": "Odyssey Number Five",
    "Artist": "Powderfinger",
    "Genre": "Alternative rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released and distributed on a major label",
    "Origin": "Queensland"
}, {
    "Year": 2002,
    "Title": "Barricades & Brickwalls",
    "Artist": "Kasey Chambers",
    "Genre": "Folk/Country",
    "Female-fronted": "Female-fronted",
    "Released": "Released and distributed on a major label",
    "Origin": "South Australia"
}, {
    "Year": 2003,
    "Title": "Vulture Street",
    "Artist": "Powderfinger",
    "Genre": "Rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released and distributed on a major label",
    "Origin": "Queensland"
}, {
    "Year": 2004,
    "Title": "Get Born",
    "Artist": "Jet",
    "Genre": "Rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released and distributed on a major label",
    "Origin": "Victoria"
}, {
    "Year": 2005,
    "Title": "The Sound Of White",
    "Artist": "Missy Higgins",
    "Genre": "Pop",
    "Female-fronted": "Female-fronted",
    "Released": "Released independently and distributed by a major label",
    "Origin": "Victoria"
}, {
    "Year": 2006,
    "Title": "Tea and Sympathy",
    "Artist": "Bernard Fanning",
    "Genre": "Alternative rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released independently and distributed by a major label",
    "Origin": "Queensland"
}, {
    "Year": 2007,
    "Title": "Young Modern",
    "Artist": "Silverchair",
    "Genre": "Alternative rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released independently and distributed by a major label",
    "Origin": "New South Wales"
}, {
    "Year": 2008,
    "Title": "Apocalypso",
    "Artist": "The Presets",
    "Genre": "Electronic",
    "Female-fronted": "Not female-fronted",
    "Released": "Released and distributed on a major label",
    "Origin": "New South Wales"
}, {
    "Year": 2009,
    "Title": "Walking On A Dream",
    "Artist": "Empire of the Sun",
    "Genre": "Electronic",
    "Female-fronted": "Not female-fronted",
    "Released": "Released and distributed on a major label",
    "Origin": "New South Wales"
}, {
    "Year": 2010,
    "Title": "Down The Way",
    "Artist": "Angus & Julia Stone",
    "Genre": "Folk/Country",
    "Female-fronted": "Female-fronted",
    "Released": "Released and distributed on a major label",
    "Origin": "New South Wales"
}, {
    "Year": 2011,
    "Title": "Moonfire",
    "Artist": "Boy & Bear",
    "Genre": "Alternative rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released and distributed on a major label",
    "Origin": "New South Wales"
}, {
    "Year": 2012,
    "Title": "Making Mirrors",
    "Artist": "Gotye",
    "Genre": "Alternative rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released independently and distributed by a major label",
    "Origin": "Victoria"
}, {
    "Year": 2013,
    "Title": "Lonerism",
    "Artist": "Tame Impala",
    "Genre": "Alternative rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released and distributed on a major label",
    "Origin": "Western Australia"
}, {
    "Year": 2014,
    "Title": "1000 Forms Of Fear",
    "Artist": "Sia",
    "Genre": "Pop",
    "Female-fronted": "Female-fronted",
    "Released": "Released and distributed independently",
    "Origin": "South Australia"
}, {
    "Year": 2015,
    "Title": "Currents",
    "Artist": "Tame Impala",
    "Genre": "Alternative rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released and distributed on a major label",
    "Origin": "Western Australia"
}, {
    "Year": 2016,
    "Title": "Skin",
    "Artist": "Flume",
    "Genre": "Electronic",
    "Female-fronted": "Not female-fronted",
    "Released": "Released and distributed independently",
    "Origin": "New South Wales"
}, {
    "Year": 2017,
    "Title": "Go Farther In Lightness",
    "Artist": "Gang Of Youths",
    "Genre": "Alternative rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released independently and distributed by a major label",
    "Origin": "New South Wales"
}, {
    "Year": 2018,
    "Title": "Love Monster",
    "Artist": "Amy Shark",
    "Genre": "Pop",
    "Female-fronted": "Female-fronted",
    "Released": "Released and distributed on a major label",
    "Origin": "Queensland"
}, {
    "Year": 2019,
    "Title": "A Place We Knew",
    "Artist": "Dean Lewis",
    "Genre": "Pop",
    "Female-fronted": "Not female-fronted",
    "Released": "Released and distributed on a major label",
    "Origin": "New South Wales"
}, {
    "Year": 2020,
    "Title": "The Slow Rush",
    "Artist": "Tame Impala",
    "Genre": "Alternative rock",
    "Female-fronted": "Not female-fronted",
    "Released": "Released and distributed on a major label",
    "Origin": "Western Australia"
}];

var w = window.innerWidth;
var h = window.innerHeight;
var min = Math.min(w, h);
var radius = Math.min(20, min / 25)
var scale = radius / 50;
var colors = d3.scaleOrdinal(d3.schemeCategory10);
var startingColour = "grey";
var colourCat = null;

const opts = [{
    label: "None",
    key: null,
}, {
    label: "Genre",
    key: "Genre",
}, {
    label: "Female-fronted",
    key: "Female-fronted",
}, {
    label: "Label/Distribution",
    key: "Released",
}, {
    label: "Artist Origin",
    key: "Origin",
}, ];

function onlyUnique(element, index, array) {
    return array.indexOf(element) == index;
}

function stringToObject(string) {
    return {
        name: string
    };
}

function wrap(text, width) {
    text.each(function () {
        var text = d3.select(this),
            words = text.text().split(/\s+/).reverse(),
            word,
            line = [],
            lineNumber = 0,
            lineHeight = 1.1, // ems
            x = text.attr("x"),
            y = text.attr("y"),
            dy = 0, //parseFloat(text.attr("dy")),
            tspan = text.text(null)
                        .append("tspan")
                        .attr("x", x)
                        .attr("y", y)
                        .attr("dy", dy + "em");
        while (word = words.pop()) {
            line.push(word);
            tspan.text(line.join(" "));
            if (tspan.node().getComputedTextLength() > width) {
                line.pop();
                tspan.text(line.join(" "));
                line = [word];
                tspan = text.append("tspan")
                            .attr("x", x)
                            .attr("y", y)
                            .attr("dy", ++lineNumber * lineHeight + dy + "em")
                            .text(word);
            }
        }
    });
}

// for each of the options add a key "vals"
// which is an array of all the possible values for that key in the dataset
for (let opt of opts) {
    if (opt.key == null)
        continue;

    const allVals = dataset.map(d=>d[opt.key]);
    const uniqueVals = allVals.filter(onlyUnique);

    // save all unique values as its own object
    // so we can associate any data with each possible value
    opt.vals = uniqueVals.map(stringToObject);

    // get the number of data with each value for sorting purposes
    opt.vals.forEach(function(v) {
        v.total = dataset.filter(d => d[opt.key]==v.name).length;
    });

    // and sort by that value
    opt.vals.sort((v0, v1) => v1.total - v0.total);

    // and add a colour for each value
    opt.vals.forEach((v, i) => v.colour = colors(i));
}

function getXCentre(element, index, array) {
    if (w > h) {
        const marg = w / (array.length + 1);
        const innerw = w - marg * 2;
        const gap = innerw / (array.length - 1);
        return marg + index * gap;
    }

    if (array.length < 3)
        return w / 2;

    const xMids = [2 * w / 3, w / 3];
    return xMids[index % 2];
}

function getYCentre(element, index, array) {
    if (w < h) {
        const marg = h / (array.length + 1);
        const innerh = h - marg * 2;
        const gap = innerh / (array.length - 1);
        return marg + index * gap;
    }

    if (array.length < 3)
        return h / 2;

    const yMids = [h / 3, 2 * h / 3];
    return yMids[index % 2];
}

for (let opt of opts) {
    if (opt.key == null) {
        opt.centre = {
            x: w / 2,
            y: h / 2,
        };
        continue;
    }

    const exes = opt.vals.map(getXCentre);
    const whys = opt.vals.map(getYCentre);
    for (let i = 0; i < opt.vals.length; i++) {
        opt.vals[i].x = exes[i];
        opt.vals[i].y = whys[i];
    }
}

// d3 stuff

var simulation = d3.forceSimulation(dataset)
.force('charge', d3.forceManyBody().strength(5))
.force("center", d3.forceCenter().x(w / 2).y(h / 2))
.force('collision', d3.forceCollide().radius(radius))
.on("tick", function() {
    nodes.attr("transform", d => `
        translate(${d.x} ${d.y})
        scale(${scale})
    `);
});

var svg = d3.select("svg");

var nodes = svg.selectAll("use")
.data(dataset)
.enter()
.append("use")
.attr("href", "#record")
.attr("transform", `scale(${scale})`)
.attr('fill', startingColour)
.on("mouseover", function(d) {
    var xPosition = d3.event.pageX;
    var yPosition = d3.event.pageY;

    d3.select(this)
    .style('opacity', 0.5);


    let htmlString = `<p>Album: ${d.Title}<br>Artist: ${d.Artist}`;
    if (colourCat) {
        const thisVal = colourCat.vals.find(v => v.name == d[colourCat.key]);
        const thisColour = thisVal.colour;
        const colourString = `<br>
            <span style="color:${thisColour}">
                ${colourCat.label}: ${thisVal.name}
            </span>
        `;
        htmlString = htmlString.concat(colourString);
    }

    d3.select("#tooltip")
    .style("left", (xPosition > w / 2)? "auto" : xPosition + "px")
    .style("right", (xPosition < w / 2)? "auto" : w - xPosition + "px")
    .style("top", yPosition + "px")
    .select("#description")
    .html(htmlString);

    d3.select("#tooltip").classed("hidden", false);

})
.on("mouseout", function() {
    d3.select(this).style('opacity', 1)
    d3.select("#tooltip").classed("hidden", true);
});

function updateColour(category) {
    svg.selectAll('use')
    .transition()
    .duration(500)
    .style('fill', function(d) {
        if (category == "None"){
            colourCat = null;
            return startingColour;
        } else {
        const opt = opts.find(o => o.key == category);
        colourCat = opt;
        return opt.vals.find(v => v.name == d[category]).colour;}
    })
}

function getCentreXY(category, axis) {
    return function(d) {
        if (category == "None")
            return opts.find(o=>o.key == null).centre[axis];

        const opt = opts.find(o=>o.key == category);
        const val = opt.vals.find(v=>v.name == d[opt.key]);

        // bad -- this is for the labels
        if (val == undefined) {
            val0 = opt.vals.find(v=>v.name == d);
            //if ()
            if (axis == 'y')
                return val0[axis] + radius * (Math.floor(Math.sqrt(val0.total)) + 2);
            return val0[axis];
        }

        return val[axis];
    }
}

function updateGroup(category) {
    simulation = simulation
    .force("center", d3.forceX(getCentreXY(category, 'x')))
    .force("centerY", d3.forceY(getCentreXY(category, 'y')))
    .alpha(1).restart();

    if (category == "None") {
        xLabels = svg.selectAll("text")
        .data([]);
    } else {
        xLabels = svg.selectAll("text")
        .data(opts.find(o=>o.key == category).vals
                .map(v=>v.name),
            d => d);
    }


    xLabels.exit().remove();

    xLabels.enter()
    .append("text")
    .text(d=>d)
    .attr("x", getCentreXY(category, 'x'))
    .attr("y", getCentreXY(category, 'y'))
    .call(wrap, 175)
    .attr('text-anchor', 'middle');

};
// create menus
for (let parent of document.querySelectorAll("div#menus select")) {
    for (let opt of opts) {
        const optElem = document.createElement("option");

        if (opt.key)
            optElem.setAttribute("value", opt.key);

        optElem.innerText = opt.label;
        parent.appendChild(optElem);
    }

    parent.addEventListener("change", function(e) {
        const selected = e.target.options[e.target.selectedIndex];
        if (e.target.id == "group-menu") {
            updateGroup(selected.value);
        } else if (e.target.id == "colour-menu") {
            updateColour(selected.value);
        } else {
            console.warn("unexpected menu id:", e.target.id);
        }
    });
}
